<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF2Booklet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body {
      margin: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 90vh;
    }
    #progressContainer { display: none; margin-top: 1rem; }
    #progressText { margin-top: 0.5rem; font-weight: 500; }
    #fileName { font-weight: 500; }
    #viewBtn, #printInstructions { display: none; }
  </style>
</head>
<body class="bg-light">
  <div class="card shadow-sm" style="max-width: 640px; width: 100%;">
    <div class="card-body">
      <h2 class="card-title text-center mb-4"><i class="fas fa-book-open"></i> PDF2Booklet</h2>

      <div class="mb-3">
        <label class="form-label"><i class="fas fa-file-pdf me-2"></i>Select PDF:</label>
        <input class="form-control" type="file" id="fileInput" accept="application/pdf"/>
        <div id="fileName" class="mt-1 text-secondary"></div>
      </div>

      <div class="mb-3">
        <label class="form-label"><i class="fas fa-key me-2"></i>Password (if protected):</label>
        <input class="form-control" type="password" id="passwordInput" placeholder="PDF password (optional)"/>
      </div>

      <button id="generateBtn" class="btn btn-primary w-100 mb-2">
        <i class="fas fa-print me-2"></i>Generate Booklet
      </button>

      <button id="viewBtn" class="btn btn-outline-secondary w-100 mb-3">
        <i class="fas fa-eye me-2"></i>View Generated PDF
      </button>

      <div id="progressContainer" class="progress">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
      </div>
      <div id="progressText" class="text-center text-muted mt-2"></div>
      <div id="errorMsg" class="text-danger mt-3"></div>

      <div id="printInstructions" class="alert alert-info mt-4">
        <h5 class="alert-heading"><i class="fas fa-print me-2"></i>How to Print the Booklet</h5>
        <ul class="mb-0 ps-3">
          <li><strong>Layout:</strong> Landscape</li>
          <li><strong>Pages per sheet:</strong> 2</li>
          <li><strong>Duplex:</strong> Double-sided (Flip on <strong>long edge</strong>)</li>
          <li><strong>Page size:</strong> A4 (210mm x 297mm)</li>
          <li><strong>Binding:</strong> Fold and staple in the center</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    const A4 = { height: 595.28, width: 841.89 };
    let generatedPdfURL = null;

    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileName');
    fileInput.addEventListener('change', () => {
      fileNameDisplay.textContent = fileInput.files[0]?.name || '';
      document.getElementById('viewBtn').style.display = 'none';
      document.getElementById('printInstructions').style.display = 'none';
    });

    function updateProgress(percent, text) {
      const bar = document.getElementById('progressBar');
      document.getElementById('progressContainer').style.display = 'block';
      bar.style.width = percent + '%';
      bar.setAttribute('aria-valuenow', percent);
      document.getElementById('progressText').textContent = text;
    }

    function resetProgress() {
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressText').textContent = '';
    }

    async function drawTwoPages(imposedPdf, srcPdf, indexA, indexB) {
      const page = imposedPdf.addPage([A4.height * 2, A4.width]);
      if (indexA !== null) {
        const [p] = await srcPdf.copyPages(srcPdf, [indexA]);
        const emb = await imposedPdf.embedPage(p);
        page.drawPage(emb, { x:0, y:0, width:A4.height, height:A4.width });
      }
      if (indexB !== null) {
        const [p] = await srcPdf.copyPages(srcPdf, [indexB]);
        const emb = await imposedPdf.embedPage(p);
        page.drawPage(emb, { x:A4.height, y:0, width:A4.height, height:A4.width });
      }
    }

    async function generateBooklet(inputBytes, password) {
      updateProgress(5, 'üîê Loading PDF...');
      const srcPdf = await PDFLib.PDFDocument.load(inputBytes, {
        ignoreEncryption: true,
        password: password || undefined
      });

      const original = srcPdf.getPageCount();
      const toAdd = (4 - (original % 4)) % 4;
      const total = original + toAdd;
      const imposedPdf = await PDFLib.PDFDocument.create();

      for (let i = 0; i < total / 4; i++) {
        const safe = idx => idx >= original ? null : idx;
        updateProgress(10 + Math.floor((i / (total / 4)) * 80), `üóÇÔ∏è Processing sheet ${i + 1} of ${total / 4}...`);
        const l1 = total - 1 - 2 * i,
              r1 = 2 * i,
              l2 = 2 * i + 1,
              r2 = total - 2 - 2 * i;
        await drawTwoPages(imposedPdf, srcPdf, safe(l1), safe(r1));
        await drawTwoPages(imposedPdf, srcPdf, safe(l2), safe(r2));
        await new Promise(r => setTimeout(r, 50));
      }

      updateProgress(95, 'üíæ Finalizing PDF...');
      const pdfBytes = await imposedPdf.save();
      updateProgress(100, '‚úÖ Booklet Ready!');

      return new Blob([pdfBytes], { type: 'application/pdf' });
    }

    document.getElementById('generateBtn').addEventListener('click', async () => {
      resetProgress();
      document.getElementById('errorMsg').textContent = '';
      document.getElementById('viewBtn').style.display = 'none';
      document.getElementById('printInstructions').style.display = 'none';
      if (!fileInput.files.length) return;

      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const bytes = new Uint8Array(reader.result);
          const pw = document.getElementById('passwordInput').value.trim();
          const blob = await generateBooklet(bytes, pw);

          if (generatedPdfURL) URL.revokeObjectURL(generatedPdfURL);
          generatedPdfURL = URL.createObjectURL(blob);

          // Download with filename
          const downloadLink = document.createElement("a");
          downloadLink.href = generatedPdfURL;
          downloadLink.download = fileInput.files[0].name.replace(/\.pdf$/i, '') + "-booklet.pdf";
          downloadLink.click();

          document.getElementById('viewBtn').style.display = 'block';
          document.getElementById('printInstructions').style.display = 'block';
          resetProgress();
        } catch (err) {
          console.error(err);
          document.getElementById('errorMsg').textContent = '‚ùå ' + err.message;
          resetProgress();
        }
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
    });

    document.getElementById('viewBtn').addEventListener('click', () => {
      if (generatedPdfURL) {
        window.open(generatedPdfURL, '_blank');
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
